<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tennis Drill — Sessions</title>
  <meta name="description" content="Register for biweekly Tennis Drill sessions. 6 slots per session. First come, first served." />
  <style>
    :root{
      --bg:#0b0f14;--panel:#0f141b;--text:#d9e1ee;--muted:#93a1b3;
      --accent:#7CFF62;--accent-2:#3ec2ff;--border:#1a2230;--ring:rgba(124,255,98,0.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background: radial-gradient(900px 450px at 20% 30%, rgba(124,255,98,0.08), transparent 60%), var(--bg);
         color:var(--text);font:16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .hero{position:relative;min-height:70vh;display:grid;place-items:center;border-bottom:1px solid var(--border)}
    .hero::before{content:"";position:absolute;inset:0;background:
      repeating-linear-gradient(0deg,transparent,transparent 46px,rgba(255,255,255,0.06) 47px),
      repeating-linear-gradient(90deg,transparent,transparent 46px,rgba(255,255,255,0.06) 47px);
      mask-image: radial-gradient(ellipse at center, rgba(0,0,0,.7), rgba(0,0,0,1) 70%);pointer-events:none}
    .hero-overlay{position:absolute;inset:0;background: radial-gradient(1000px 500px at 50% 10%, rgba(124,255,98,0.15), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.4));pointer-events:none}
    .hero-content{position:relative;z-index:1;text-align:center;padding:48px 24px;max-width:940px}
    .title{font-size:clamp(40px,6vw,72px);margin:0 0 12px;background:linear-gradient(90deg,var(--accent) 0%,#a0ffd1 25%,var(--accent-2) 55%,#9ad3ff 75%,var(--accent) 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{margin:0 0 12px} .rules{list-style:none;padding:0;margin:0 0 28px;color:var(--muted)} .rules li{margin:4px 0}
    .cta{appearance:none;border:0;padding:14px 22px;font-weight:700;border-radius:14px;letter-spacing:.2px;color:#00141a;cursor:pointer;
      background: radial-gradient(80% 220% at 10% 10%, var(--accent), var(--accent-2));
      box-shadow: 0 10px 24px rgba(60,150,255,0.25), inset 0 0 0 2px rgba(0,0,0,0.05)}
    .section{max-width:800px;margin:56px auto;padding:0 20px}
    #register.section{width:800px;max-width:800px;margin-left:auto;margin-right:auto}
    @media (max-width:860px){#register.section{width:100%}}
    .card{background:linear-gradient(180deg,rgba(124,255,98,0.06),rgba(124,255,98,0.03));border:1px solid var(--border);border-radius:16px;padding:18px}
    .lbl{display:block;font-weight:600;margin:10px 0 6px;color:var(--muted)}
    .input{width:100%;background: #0f141b;border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:12px}
    .input:focus{outline:0;box-shadow:0 0 0 4px var(--ring)}
    select.input{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23d9e1ee' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat:no-repeat;background-position:right 16px center;padding-right:44px}
    .grid{display:grid;gap:12px;align-items:end}
    /* Put button to the right of the input on >= 560px */
    @media (min-width:560px){ .grid{ grid-template-columns: 1fr auto; } }
    .btns{display:flex;gap:8px;margin-top:0; align-self:end}
    .btn{appearance:none;border:1px solid var(--border);background:#0f141b;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.primary{border:1px solid rgba(62,194,255,0.35);color:#001410;background:linear-gradient(135deg,var(--accent) 0%,#b7ff98 30%,var(--accent-2) 70%,#a8e4ff 100%)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .status{min-height:24px;margin:8px 0 0;color:var(--muted)}
    .meta{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:16px 0 0}
    .meta .k{display:block;font-size:12px;color:var(--muted)} .meta .v{display:block;font-size:16px;font-weight:700}
    .list{list-style:none;padding:0;margin:8px 0 0}
    .list li{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#0e141b}
    .left{display:inline-flex;align-items:center;gap:8px}
    .left .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    .left .tag{font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-left:6px}
    .list button.cancel{appearance:none;border:1px solid var(--border);background:transparent;color:var(--muted);padding:6px 10px;border-radius:10px;font-weight:600;cursor:pointer}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#1a2230,transparent);margin:16px 0 8px;display:none}
    .note{color:var(--muted);font-size:14px;margin-top:14px}
    .footer{border-top:1px solid var(--border);color:var(--muted);text-align:center;padding:24px 0 60px}
  </style>
</head>
<body>
<header class="hero">
  <div class="hero-overlay"></div>
  <div class="hero-content">
    <h1 class="title">Tennis Drill</h1>
    <p class="subtitle">Bi-weekly sessions starting Aug 7, 2025. <br /><strong>6 slots</strong> per session — first come, first served.</p>
    <ul class="rules">
      <li>Register with your name. You can cancel anytime before the session.</li>
      <li>Registration closes at <strong>5:00 PM (day of session)</strong>, America/Denver.</li>
    </ul>
    <button id="registerBtn" class="cta">Register Now</button>
  </div>
</header>

<main>
  <section id="register" class="section">
    <h2>Register for a Session</h2>
    <div class="card">
      <form id="regForm">
        <label class="lbl" for="sessionSelect">Choose session</label>
        <select id="sessionSelect" class="input"></select>

        <div class="grid">
          <div>
            <label class="lbl" for="nameInput">Your name</label>
            <input id="nameInput" class="input" placeholder="e.g., Alex Kim" maxlength="60" />
          </div>
          <div class="btns">
            <button id="doRegister" class="btn primary" type="submit">Register</button>
          </div>
        </div>

        <p id="status" class="status" aria-live="polite"></p>
      </form>

      <div class="meta">
        <div><span class="k">Remaining</span> <span id="remainingV" class="v">—</span></div>
        <div><span class="k">Deadline</span> <span id="deadlineV" class="v">—</span></div>
      </div>

      <div class="listWrap">
        <h3>Current Registrations</h3>
        <ul id="nameList" class="list"></ul>
      </div>

      <div id="divider" class="divider"></div>

      <div id="waitWrap" class="listWrap" style="display:none">
        <h3>Waitlist</h3>
        <ul id="waitList" class="list"></ul>
      </div>
    </div>

    <p class="note">
      Shared sign-ups are backed by a lightweight server (Vercel KV). If the server isn't present (local preview), this page falls back to demo localStorage.
    </p>
  </section>
</main>

<footer class="footer">
  <p>© <span id="year"></span> Tennis Drill</p>
</footer>

<script>
  const START_DATE_ISO = "2025-08-07";
  const SLOT_LIMIT = 6;
  const SESSIONS_TO_LIST = 20;
  const STORAGE_PREFIX = "tennis_drill_session_v3_";
  const DEVICE_ID_KEY = "tennis_drill_device_id";

  let USING_BACKEND = false;

  const $ = (s)=>document.querySelector(s);
  const sessionSelect = $("#sessionSelect");
  const nameInput = $("#nameInput");
  const doRegister = $("#doRegister");
  const statusEl = $("#status");
  const deadlineV = $("#deadlineV");
  const remainingV = $("#remainingV");
  const nameList = $("#nameList");
  const waitList = $("#waitList");
  const waitWrap = $("#waitWrap");
  const divider = $("#divider");

  function ensureDeviceId(){
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if(!id){ id=Math.random().toString(36).slice(2)+Date.now().toString(36); localStorage.setItem(DEVICE_ID_KEY,id) }
    return id;
  }
  const DEVICE_ID = ensureDeviceId();

  function toDateLocal(iso){ const [y,m,d]=iso.split("-").map(Number); return new Date(y,m-1,d) }
  function fmtDateLong(d){ return d.toLocaleString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric"}) }
  // NEW: same-day 5:00 PM deadline (America/Denver displayed using local time)
  function fmtDeadline(d){ const x=new Date(d); x.setHours(17,0,0,0); return x }
  function nowLocal(){ return new Date() }
  function endOfDayLocal(d){ const e=new Date(d); e.setHours(23,59,59,999); return e }
  function isFinished(d){ return nowLocal()>endOfDayLocal(d) }

  function getKey(iso){ return STORAGE_PREFIX+iso }
  function safeParse(json,fallback){ try{return JSON.parse(json)}catch(_){return fallback} }
  function normalize(arr){ return (arr||[]).map(x=>typeof x==="string"?{name:x,device:null}:{name:String(x.name||""),device:x.device||null}) }
  function getStateLocal(iso){
    const raw=localStorage.getItem(getKey(iso));
    if(!raw){
      const old=localStorage.getItem("tennis_drill_session_v2_"+iso)||localStorage.getItem("tennis_drill_session_"+iso);
      if(old){ const p=safeParse(old,[]); const regs=Array.isArray(p.regs)?normalize(p.regs):normalize(p); return {regs,waitlist:[]} }
      return {regs:[],waitlist:[]}
    }
    const p=safeParse(raw,null); if(!p) return {regs:[],waitlist:[]}
    return {regs:normalize(p.regs||p), waitlist:normalize(p.waitlist||[])}
  }
  function setStateLocal(iso, state){ const s={regs:normalize(state.regs||[]),waitlist:normalize(state.waitlist||[])}; localStorage.setItem(getKey(iso),JSON.stringify(s)) }

  async function fetchSession(iso){
    if(!USING_BACKEND) return null;
    try{ const r=await fetch(`/api/session?date=${iso}`,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json() }catch{ USING_BACKEND=false; return null }
  }
  async function apiRegister(iso,name,device){
    if(!USING_BACKEND) return null;
    try{ const r=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:iso,name,device})}); return await r.json() }catch{ USING_BACKEND=false; return null }
  }
  async function apiCancel(iso,token){
    if(!USING_BACKEND) return null;
    try{ const r=await fetch('/api/cancel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:iso,device:token.device||null,name:token.name||null})}); return await r.json() }catch{ USING_BACKEND=false; return null }
  }

  async function detectBackend(){
    const iso=sessionSelect.value; if(!iso){USING_BACKEND=false;return}
    try{ const r=await fetch(`/api/session?date=${iso}`,{cache:'no-store'}); if(!r.ok){USING_BACKEND=false;return} const j=await r.json(); USING_BACKEND = j && Array.isArray(j.regs) && Array.isArray(j.waitlist); if(!USING_BACKEND) statusEl.textContent="Server unavailable — running in local demo mode." }catch{ USING_BACKEND=false; statusEl.textContent="Server unavailable — running in local demo mode." }
  }

  function generateSessions(fromIso,count){ const start=toDateLocal(fromIso); const out=[]; for(let i=0;i<count;i++){ const d=new Date(start); d.setDate(d.getDate()+i*14); out.push(d) } return out }
  function populateSessions(){
    const many=generateSessions(START_DATE_ISO,SESSIONS_TO_LIST*12);
    let upcoming = many.filter(d=>!isFinished(d));
    if(upcoming.length===0){
      const start=toDateLocal(START_DATE_ISO); const today=nowLocal();
      const days=Math.floor((today-start)/(24*60*60*1000)); const steps=Math.max(0,Math.ceil(days/14));
      const next=new Date(start); next.setDate(next.getDate()+steps*14);
      upcoming = generateSessions(next.toISOString().slice(0,10), SESSIONS_TO_LIST);
    }
    const prev=sessionSelect.value; sessionSelect.innerHTML="";
    upcoming.slice(0,SESSIONS_TO_LIST).forEach(d=>{ const iso=d.toISOString().slice(0,10); const o=document.createElement("option"); o.value=iso; o.textContent=`${fmtDateLong(d)} (${iso})`; sessionSelect.appendChild(o) });
    if(prev && [...sessionSelect.options].some(o=>o.value===prev)) sessionSelect.value=prev;
    else if(sessionSelect.options.length) sessionSelect.value=sessionSelect.options[0].value;
  }

  function hasOwnEntry(state){
    const inRegs=state.regs.find(e=>e.device===DEVICE_ID);
    const inWait=state.waitlist.find(e=>e.device===DEVICE_ID);
    return inRegs||inWait||null;
  }

  function renderLists(state){
    const bind = (btn)=>btn.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation(); const iso=sessionSelect.value; const token={device:btn.getAttribute("data-device"),name:btn.getAttribute("data-name")}; void cancelEntry(iso,token)});

    nameList.innerHTML="";
    state.regs.forEach(e=>{
      const li=document.createElement("li");
      const left=document.createElement("span"); left.className="left";
      const dot=document.createElement("span"); dot.className="dot";
      const label=document.createElement("span"); label.textContent=e.name;
      left.appendChild(dot); left.appendChild(label);
      if(e.device===DEVICE_ID){ const tag=document.createElement("span"); tag.className="tag"; tag.textContent="Yours"; left.appendChild(tag) }
      li.appendChild(left);
      if(e.device===DEVICE_ID){ const b=document.createElement("button"); b.className="cancel"; b.type="button"; b.textContent="Cancel"; b.setAttribute("data-name",e.name); b.setAttribute("data-device",DEVICE_ID); li.appendChild(b); bind(b) }
      nameList.appendChild(li);
    });

    waitList.innerHTML="";
    state.waitlist.forEach((e,idx)=>{
      const li=document.createElement("li");
      const left=document.createElement("span"); left.className="left";
      const pos=document.createElement("span"); pos.textContent=`#${idx+1}`; pos.style.color="var(--muted)";
      const dot=document.createElement("span"); dot.className="dot";
      const label=document.createElement("span"); label.textContent=e.name;
      left.appendChild(pos); left.appendChild(dot); left.appendChild(label);
      if(e.device===DEVICE_ID){ const tag=document.createElement("span"); tag.className="tag"; tag.textContent="Yours"; left.appendChild(tag) }
      li.appendChild(left);
      if(e.device===DEVICE_ID){ const b=document.createElement("button"); b.className="cancel"; b.type="button"; b.textContent="Cancel"; b.setAttribute("data-name",e.name); b.setAttribute("data-device",DEVICE_ID); li.appendChild(b); bind(b) }
      waitList.appendChild(li);
    });
  }

  async function updateUI(){
    const iso=sessionSelect.value;
    if(!iso){ remainingV.textContent="—"; deadlineV.textContent="—"; nameList.innerHTML=""; waitList.innerHTML=""; divider.style.display="none"; waitWrap.style.display="none"; doRegister.disabled=true; statusEl.textContent="No upcoming sessions."; return }

    let state, closed;
    if(USING_BACKEND){ const data=await fetchSession(iso); if(data){ state={regs:data.regs||[], waitlist:data.waitlist||[]}; closed=!!data.closed } }
    if(!state){ const sessionDate=toDateLocal(iso); state=getStateLocal(iso); closed=nowLocal()>fmtDeadline(sessionDate) }

    const remaining=Math.max(0, SLOT_LIMIT - state.regs.length);
    const isFull=remaining===0;
    const deadline=fmtDeadline(toDateLocal(iso));

    remainingV.textContent = remaining+" out of "+SLOT_LIMIT;
    deadlineV.textContent = deadline.toLocaleString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});

    renderLists(state);

    const showWait=state.waitlist.length>0;
    divider.style.display = showWait ? "block" : "none";
    waitWrap.style.display = showWait ? "block" : "none";

    doRegister.textContent = isFull ? "Add to waitlist" : "Register";
    doRegister.dataset.mode = isFull ? "wait" : "reg";
    doRegister.disabled = closed;

    const mine=hasOwnEntry(state);
    if(mine){ doRegister.disabled=true; statusEl.textContent=`This device already has a ${mine.device===DEVICE_ID?"registration":"record"} under "${mine.name}". Cancel it to change.` }
    else if(closed){ statusEl.textContent="Registration is closed for this session (after 5 PM). You can still cancel." }
    else if(isFull){ statusEl.textContent="This session is full. You can join the waitlist." }
    else { statusEl.textContent = USING_BACKEND ? "" : "(Demo mode: local to this browser)"; }
  }

  function cleanName(s){ return (s||"").trim().replace(/\s+/g," ") }

  async function onRegister(e){
    e.preventDefault();
    const iso=sessionSelect.value; const name=cleanName(nameInput.value);
    if(!name){ statusEl.textContent="Please enter your name."; nameInput.focus(); return }

    if(USING_BACKEND){
      const res=await apiRegister(iso,name,DEVICE_ID);
      if(!res){ statusEl.textContent="Server unavailable — saved locally for now." }
      else if(!res.ok){ const map={closed:"Registration is closed for this session.","already-has-spot":"This device already has a spot. Cancel it first.","name-exists":"You're already on the list.",busy:"Please try again."}; statusEl.textContent=map[res.error]||"Failed to register."; await updateUI(); return }
      else { statusEl.textContent = res.mode==='waitlisted' ? `Session is full — added to waitlist (position #${res.position}).` : "Registered! See you on court."; await updateUI(); nameInput.value=""; return }
    }

    const sessionDate=toDateLocal(iso); const deadline=fmtDeadline(sessionDate);
    if(nowLocal()>deadline){ await updateUI(); return }

    const state=getStateLocal(iso);
    if(hasOwnEntry(state)){ statusEl.textContent="This device already has a spot. Cancel it first."; return }
    if(state.regs.some(e=>e.name===name)||state.waitlist.some(e=>e.name===name)){ statusEl.textContent="You're already on the list."; return }
    const entry={name,device:DEVICE_ID};
    if(state.regs.length<SLOT_LIMIT){ state.regs.push(entry); setStateLocal(iso,state); statusEl.textContent="Registered! See you on court." }
    else { state.waitlist.push(entry); setStateLocal(iso,state); const pos=state.waitlist.length; statusEl.textContent=`Session is full — added to waitlist (position #${pos}).` }
    nameInput.value=""; await updateUI();
  }

  async function cancelEntry(iso, token){
    if(USING_BACKEND){
      const res=await apiCancel(iso, token);
      if(!res){ statusEl.textContent="Server unavailable — if you cancel now it only affects this browser." }
      else if(!res.ok){ statusEl.textContent = res.error==='forbidden-or-not-found' ? "You can only cancel your own spot." : "Failed to cancel."; await updateUI(); return }
      else { statusEl.textContent = res.promoted ? `Your spot has been canceled. Promoted ${res.promoted.name} from waitlist.` : "Canceled."; await updateUI(); return }
    }

    const state=getStateLocal(iso);
    const dev=token&&token.device||null; const nm=token&&token.name||"";
    if(dev && dev!==DEVICE_ID){ statusEl.textContent="You can only cancel your own spot."; setStateLocal(iso,state); await updateUI(); return }

    if(dev===DEVICE_ID){
      let idx=state.regs.findIndex(e=>e.device===DEVICE_ID);
      if(idx!==-1){ state.regs.splice(idx,1); if(state.waitlist.length){ const promoted=state.waitlist.shift(); state.regs.push(promoted); statusEl.textContent=`Your spot has been canceled. Promoted ${promoted.name} from waitlist.` } else { statusEl.textContent="Your spot has been canceled." } }
      else { idx=state.waitlist.findIndex(e=>e.device===DEVICE_ID); if(idx!==-1){ state.waitlist.splice(idx,1); statusEl.textContent="Removed from waitlist." } }
    } else {
      const typed=(nameInput.value||"").trim();
      if(!typed || typed!==nm){ statusEl.textContent="Type this exact name in the input above, then click Cancel again."; setStateLocal(iso,state); await updateUI(); return }
      let idx=state.regs.findIndex(e=>e.device==null && e.name===nm);
      if(idx!==-1){ state.regs.splice(idx,1); if(state.waitlist.length){ const promoted=state.waitlist.shift(); state.regs.push(promoted); statusEl.textContent=`Canceled. Promoted ${promoted.name} from waitlist.` } else { statusEl.textContent="Canceled." } }
      else { idx=state.waitlist.findIndex(e=>e.device==null && e.name===nm); if(idx!==-1){ state.waitlist.splice(idx,1); statusEl.textContent="Canceled from waitlist." } else { statusEl.textContent="No matching entry found." } }
    }
    setStateLocal(iso,state); await updateUI();
  }

  document.addEventListener("DOMContentLoaded",()=>{ populateSessions(); detectBackend().then(updateUI);
    document.querySelector("#registerBtn").addEventListener("click",()=>document.querySelector("#register").scrollIntoView({behavior:"smooth"}));
    document.querySelector("#regForm").addEventListener("submit",e=>onRegister(e));
    sessionSelect.addEventListener("change",()=>updateUI());
    [nameList,waitList].forEach(list=>list.addEventListener("click",e=>{ const btn=e.target.closest("button.cancel"); if(!btn) return; e.preventDefault(); e.stopPropagation(); const iso=sessionSelect.value; const token={device:btn.getAttribute("data-device"),name:btn.getAttribute("data-name")}; cancelEntry(iso,token) }));
    document.querySelector("#year").textContent=new Date().getFullYear();
  });
</script>
</body>
</html>
